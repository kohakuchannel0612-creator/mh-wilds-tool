<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MHWilds 乱舞ツール（仮）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 16px; line-height: 1.4; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; max-width: 1000px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 360px 1fr; } }

    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; background: #fff; }
    .row { display: grid; grid-template-columns: 1fr 120px; gap: 8px; align-items: center; margin: 8px 0; }
    label { font-size: 13px; color: #333; }
    input, select { width: 100%; padding: 6px 8px; border: 1px solid #ccc; border-radius: 8px; }
    input[type="checkbox"] { width: auto; }
    .btns { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    button { padding: 8px 12px; border-radius: 10px; border: 1px solid #ccc; background: #f7f7f7; cursor: pointer; }
    button.primary { background: #222; color: #fff; border-color: #222; }
    button:disabled { opacity: .5; cursor: not-allowed; }

    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { border-bottom: 1px solid #eee; padding: 6px 6px; text-align: left; }
    th { background: #fafafa; position: sticky; top: 0; z-index: 1; }
    .muted { color: #666; font-size: 12px; }
    .ok { color: #0a7; }
    .ng { color: #c22; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    /* 既存の style の下に追記でOK */

  .sheet {
    display: grid;
    gap: 12px;
  }

  /* 上：各種設定（8〜10個を横に流す） */
  .settingsGrid {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr)); /* 4列 */
    gap: 10px 14px;
    align-items: end;
  }
  @media (min-width: 1100px) {
    .settingsGrid { grid-template-columns: repeat(6, minmax(0, 1fr)); } /* 横に広いなら6列 */
  }

  .field {
    display: grid;
    gap: 4px;
  }
  .field label {
    font-size: 12px;
    color: #444;
  }
  .field input, .field select {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 999px; /* シートの丸いプルダウン感 */
    background: #fff;
  }

  .sectionTitle {
    font-weight: 700;
    font-size: 13px;
    margin: 4px 0 0;
  }

  /* 下：スキル群（スクショみたいに横へ並べる） */
  .skillGrid {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr)); /* 4列 */
    gap: 10px 14px;
  }
  @media (min-width: 1100px) {
    .skillGrid { grid-template-columns: repeat(6, minmax(0, 1fr)); } /* 横広なら6列 */
  }

  .divider {
    border: none;
    border-top: 1px solid #eee;
    margin: 8px 0;
  }

  /* ON/OFFは見た目をselectに寄せる */
  .toggleRow {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    align-items: center;
  }
  .toggleRow input[type="checkbox"] {
    transform: scale(1.2);
  }
    /* 上下2段のレイアウト */
  .stack {
    display: grid;
    gap: 16px;
    max-width: 1100px;
  }

  .panel {
    border: 1px solid #ddd;
    border-radius: 24px;          /* 角丸大きめ */
    padding: 16px;
    background: #fff;
    min-height: 240px;            /* 枠の高さを確保（好みで調整） */
  }

  .panelTitle {
    font-size: 16px;
    font-weight: 700;
    margin: 0 0 10px;
  }
  </style>
</head>

<body>
  <h1>MHWilds 乱舞ツール（仮）</h1>
  <p class="muted">
    ※計算ロジックは <span class="mono">calc()</span> 以下に隔離。UIは入力→計算→表表示だけ。<br>
    ※完成後に公開/広告を入れる想定のフックは用意してあります（今は無効）。
  </p>

<div class="stack">

  <!-- ===== 上：入力 ===== -->
  <section class="panel">
    <div class="panelTitle">入力</div>

      <!-- 基本 -->
<section class="card">
  <h2 style="font-size:14px;margin:0 0 8px;">Inputs（シート配置寄せ）</h2>

  <div class="sheet">

    <!-- ===== 各種設定（上段） ===== -->
    <div class="sectionTitle">各種設定</div>
    <div class="settingsGrid">

      <div class="field">
        <label>基礎内部攻撃力（C3）</label>
        <input id="C3_A_base" type="number" value="205" step="1">
      </div>

      <div class="field">
        <label>基礎属性値（E3）</label>
        <input id="E3_E_base" type="number" value="270" step="1">
      </div>

      <div class="field">
        <label>斬れ味（物理倍率）（G3）</label>
        <input id="G3_sharpRaw" type="number" value="1.32" step="0.001">
      </div>

      <div class="field">
        <label>斬れ味（属性倍率）（I3）</label>
        <input id="I3_sharpElem" type="number" value="1.151" step="0.001">
      </div>

      <div class="field">
        <label>物理肉質（C4）0.45 or 45</label>
        <input id="C4_hzvRaw" type="number" value="45" step="0.1">
      </div>

      <div class="field">
        <label>属性肉質（E4）0.25 or 25</label>
        <input id="E4_hzvElem" type="number" value="5" step="0.1">
      </div>

      <div class="field">
        <label>基礎会心率（G4）0.10 or 10</label>
        <input id="G4_critBase" type="number" value="5" step="0.1">
      </div>

      <div class="field">
        <label>復元ボーナス総枠（C5）</label>
        <input id="C5_totalSlots" type="number" value="5" min="0" step="1">
      </div>

      <div class="field">
        <label>切れ味枠（E5）</label>
        <input id="E5_sharpCnt" type="number" value="1" min="0" step="1">
      </div>

      <div class="field">
        <label>表示件数 TopN（G5）</label>
        <input id="G5_topN" type="number" value="10" min="1" max="200" step="1">
      </div>

      <div class="field">
        <label>丸め方式（I5）</label>
        <input id="I5_roundMode" type="number" value="9" step="1">
      </div>

      <div class="field">
        <label>超会心Lv（C15）</label>
        <select id="C15_superCritLv">
          <option>0</option><option>1</option><option>2</option><option>3</option><option selected>4</option><option>5</option>
        </select>
      </div>

    </div>

    <hr class="divider">

    <!-- ===== 攻撃力関係（中段） ===== -->
    <div class="sectionTitle">攻撃力関係</div>
    <div class="skillGrid">
      <div class="field">
        <label>攻撃（C8）</label>
        <input id="C8_attackSkillLv" type="number" value="5" min="0" max="5" step="1">
      </div>

      <div class="field">
        <label>巧撃（E8）</label>
        <input id="E8_kougekiLv" type="number" value="3" min="0" max="5" step="1">
      </div>

      <div class="field">
        <label>フルチャージ（G8）</label>
        <input id="G8_fullChargeLv" type="number" value="0" min="0" max="5" step="1">
      </div>

      <div class="field">
        <label>攻めの守勢（I8）</label>
        <input id="I8_semeNoShuseiLv" type="number" value="0" min="0" max="3" step="1">
      </div>

      <div class="field">
        <label>逆襲（C9）</label>
        <input id="C9_gyakushuLv" type="number" value="0" min="0" max="3" step="1">
      </div>

      <div class="field">
        <label>ヌシの魂（E9）</label>
        <select id="E9_nushiNoTamashiiOn">
          <option value="OFF">OFF</option>
          <option value="ON" selected>ON</option>
        </select>
      </div>

      <div class="field">
        <label>心眼（G9）</label>
        <input id="G9_shinganLv" type="number" value="0" min="0" max="3" step="1">
      </div>

      <div class="field">
        <label>黒蝕一体 II（I9）</label>
        <select id="I9_kokushokuIttaiOn">
          <option value="OFF" selected>OFF</option>
          <option value="ON">ON</option>
        </select>
      </div>
    </div>

    <hr class="divider">

    <!-- ===== 属性関係 ===== -->
    <div class="sectionTitle">属性関係</div>
    <div class="skillGrid">
      <div class="field">
        <label>属性攻撃強化Lv（C12）</label>
        <input id="C12_elemAtkUpLv" type="number" value="0" min="0" max="3" step="1">
      </div>

      <div class="field">
        <label>災禍転福（E12）</label>
        <input id="E12_saikaLv" type="number" value="0" min="0" max="3" step="1">
      </div>

      <div class="field">
        <label>宣戦呼応（G12）</label>
        <input id="G12_senseiKououLv" type="number" value="0" min="0" max="2" step="1">
      </div>

      <div class="field">
        <label>会心撃【属性】（I12）</label>
        <input id="I12_critAttackElemLv" type="number" value="0" min="0" max="3" step="1">
      </div>
    </div>

    <hr class="divider">

    <!-- ===== 会心関係 ===== -->
    <div class="sectionTitle">会心関係</div>
    <div class="skillGrid">
      <div class="field">
        <label>弱点特攻（E15）</label>
        <input id="E15_wexLv" type="number" value="5" min="0" max="5" step="1">
      </div>
      <div class="field">
        <label>渾身（G15）</label>
        <input id="G15_konshinLv" type="number" value="0" min="0" max="3" step="1">
      </div>
      <div class="field">
        <label>力の解放（I15）</label>
        <input id="I15_chikaraNoKaihouLv" type="number" value="0" min="0" max="5" step="1">
      </div>

      <div class="field">
        <label>狂竜症克服（C16）</label>
        <select id="C16_kyouryuuKokufukuOn">
          <option value="OFF" selected>OFF</option>
          <option value="ON">ON</option>
        </select>
      </div>

      <div class="field">
        <label>無我の境地（E16）</label>
        <input id="E16_mugaLv" type="number" value="0" min="0" max="3" step="1">
      </div>
    </div>

    <hr class="divider">

    <!-- ===== 複数（スクショ下段） ===== -->
    <div class="sectionTitle">複数</div>
    <div class="skillGrid">
      <div class="field">
        <label>挑戦者（C19）</label>
        <input id="C19_challengerLv" type="number" value="5" min="0" max="5" step="1">
      </div>
      <div class="field">
        <label>連撃（E19）</label>
        <input id="E19_rengekiLv" type="number" value="5" min="0" max="5" step="1">
      </div>
      <div class="field">
        <label>連撃強化（G19）</label>
        <input id="G19_rengekiBoostLv" type="number" value="2" min="0" max="2" step="1">
      </div>
    </div>

    <div class="btns" style="margin-top:12px;">
      <button class="primary" id="btnCalc">最適化実行</button>
      <button id="btnReset">リセット</button>
    </div>

    <p class="muted" id="status"></p>
  </div>
</section>


      
      <!-- 将来の広告（今は隠す） -->
      <div id="ads-bottom" style="display:none; margin-top:12px; border-top:1px dashed #ddd; padding-top:10px;">
        <!-- 広告コードは完成後にここへ -->
      </div>
    </section>

   <!-- ===== 下：結果 ===== -->
  <section class="panel">
    <div class="panelTitle">結果</div>

    <div class="muted" id="summary"></div>

    <div style="overflow:auto; max-height:55vh; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>期待ダメ</th>
            <th>激化タイプ</th>
            <th>復元ボーナス</th>
            <th>最終会心率</th>
            <th>属性(上限前)</th>
            <th>属性(適用後)</th>
            <th>上限</th>
            <th>上限?</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

</div>

<script>
/** =========================
 *  公開/広告スイッチ（完成後に true）
 *  ========================= */
const IS_PUBLIC = false;

/** =========================
 *  ここから「計算ロジック」ゾーン
 *  UIとは切り離す
 *  ========================= */

const CRIT_MULT_BY_SUPERCRIT = { 0:1.25, 1:1.28, 2:1.31, 3:1.34, 4:1.37, 5:1.40 };

// 乱舞グループ（あなたの定義をそのまま）
const RAMBU_GROUPS = [
  { mv: 18, count: 2, elem: 1.0 },
  { mv: 6,  count: 2, elem: 0.6 },
  { mv: 10, count: 2, elem: 0.6 },
  { mv: 4,  count: 2, elem: 0.8 },
  { mv: 20, count: 2, elem: 0.8 },
  { mv: 11, count: 2, elem: 0.8 },
  { mv: 16, count: 2, elem: 0.6 },
  { mv: 6,  count: 1, elem: 0.8 },
  { mv: 25, count: 1, elem: 0.8 },
  { mv: 22, count: 1, elem: 0.6 },
  { mv: 8,  count: 1, elem: 0.6 },
  { mv: 5,  count: 1, elem: 0.6 },
  { mv: 22, count: 1, elem: 0.6 },
  { mv: 5,  count: 1, elem: 0.8 },
  { mv: 14, count: 1, elem: 0.8 },
  { mv: 18, count: 1, elem: 0.8 },
  { mv: 8,  count: 1, elem: 0.8 },
  { mv: 18, count: 1, elem: 0.8 },
  { mv: 36, count: 2, elem: 0.8 },
];

function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }
function round1(x){ return Math.round(x*10)/10; }

function getAttackSkillMult(lv){ return (lv===4)?1.02:(lv===5)?1.04:1.0; }
function getAttackSkillAdd(lv){ return (lv===1)?3:(lv===2)?5:(lv===3)?7:(lv===4)?8:(lv===5)?9:0; }

function getShinganAtkMult_(lv){
  lv = clamp(Number(lv)||0,0,3);
  return (lv===1)?1.10:(lv===2)?1.20:(lv===3)?1.30:1.00;
}

function getSenseiKououBonus_(lv){
  lv = clamp(Number(lv)||0,0,2);
  if(lv===1) return { elemMult:1.20, elemAdd:20 };
  if(lv===2) return { elemMult:1.30, elemAdd:40 };
  return { elemMult:1.00, elemAdd:0 };
}

// 属性攻撃強化（分割済み想定）
function getElemAtkUpMult_(lv){
  lv = clamp(Number(lv)||0,0,3);
  if(lv===2) return 1.1;
  if(lv===3) return 1.2;
  return 1.0; // Lv0,1は乗算なし
}
function getElemAtkUpAdd_(lv){
  lv = clamp(Number(lv)||0,0,3);
  if(lv===1) return 40;
  if(lv===2) return 50;
  if(lv===3) return 60;
  return 0;
}

function elementCapFromBase(baseElem){
  return Math.max(baseElem + 400, baseElem * 2.3);
}

// 期待ダメ計算（あなたの構造に合わせたミニ版）
// ※会心撃【属性】などは後でここに追加してOK
function calcRambuExpectedDamage({A,E,sharpRaw,sharpElem,hzvRaw,hzvElem,critRate,critMult,roundMode}){
  const r = clamp(critRate,0,1);
  const mode = Number(roundMode)||0;
  let total = 0;

  for(const g of RAMBU_GROUPS){
    const rawBasePerHit  = A * (g.mv/100) * sharpRaw * hzvRaw;
    const elemPerHit     = (E/10) * g.elem * sharpElem * hzvElem;

    const perHit = rawBasePerHit * ((1-r)+r*critMult) + elemPerHit;

    if(mode===10){
      total += round1(perHit) * g.count;
    }else{
      total += perHit * g.count;
    }
  }
  if(mode===10) return round1(total);
  return total;
}

/**
 * これが“外に出す”計算API
 * GASの optimizeRestorationBonuses_Rambu の入口に相当
 */
function calc(input){
  // --- 攻撃系 ---
  const critMult = CRIT_MULT_BY_SUPERCRIT[input.superCritLv] ?? 1.25;

  const atkSkillMult = getAttackSkillMult(input.attackSkillLv);
  const atkSkillAdd  = getAttackSkillAdd(input.attackSkillLv);

  const shinganActive  = Number.isFinite(input.hzvRaw) && input.hzvRaw < 0.45;
  const shinganAtkMult = shinganActive ? getShinganAtkMult_(input.shinganLv) : 1.0;

  // 黒蝕一体：ONで +15（あなたの方針に合わせて加算でOK）
  const A_kokushokuIttaiAdd = input.kokushokuIttaiOn ? 15 : 0;

  // ※ここに「攻めの守勢」「ヌシ魂」など倍率が増えるなら掛け算に足していく
  const atkMultTotal = 1.0 * atkSkillMult * shinganAtkMult;

  // ここはあなたの“正しい”方針（加算部）
  const atkFlatAfterMultTotal =
    atkSkillAdd
    + A_kokushokuIttaiAdd;

  const A_final = (input.A_base * atkMultTotal) + atkFlatAfterMultTotal;

  // --- 属性系（乗算→加算の順を厳密に） ---
  const sensei = getSenseiKououBonus_(input.senseiKououLv);
  const elemAtkUpMult = getElemAtkUpMult_(input.elemAtkUpLv);
  const elemAtkUpAdd  = getElemAtkUpAdd_(input.elemAtkUpLv);

  // ※将来「災禍転福」「連撃」などがあるならここに積む（乗算/加算を分けて）
  const elemMulted = 1.0 * sensei.elemMult * elemAtkUpMult;
  const elemAdded  = 0 + sensei.elemAdd + elemAtkUpAdd;

  const elemUncapped = input.E_base * elemMulted + elemAdded;
  const elemCap      = elementCapFromBase(input.E_base);
  const E_final      = Math.min(elemUncapped, elemCap);

  const dmg = calcRambuExpectedDamage({
    A: A_final,
    E: E_final,
    sharpRaw: input.sharpRaw,
    sharpElem: input.sharpElem,
    hzvRaw: input.hzvRaw,
    hzvElem: input.hzvElem,
    critRate: input.critBase,
    critMult,
    roundMode: input.roundMode,
  });

  // いまは復元最適化を入れてないので、結果を1行だけ返す（後でTopNに拡張）
  return [{
    rank: 1,
    dmg,
    type: "（仮）",
    combo: "—",
    critFinal: input.critBase,
    elemUncapped,
    elemCapped: E_final,
    elemCap,
    isElemCapped: elemUncapped > elemCap
  }];
}

/** =========================
 *  ここから「UI」ゾーン
 *  ========================= */

function isOnSelect(id){
  const v = String(document.getElementById(id).value).toUpperCase();
  return (v === "ON" || v === "TRUE" || v === "1" || v === "YES");
}


function getInput(){
  return {
    // 基本
    A_base: Number(document.getElementById("C3_A_base").value),
    E_base: Number(document.getElementById("E3_E_base").value),
    sharpRaw: Number(document.getElementById("G3_sharpRaw").value),
    sharpElem: Number(document.getElementById("I3_sharpElem").value),

    hhzvRaw:  toRate01(document.getElementById("C4_hzvRaw").value),
    hzvElem: toRate01(document.getElementById("E4_hzvElem").value),
    critBase:toRate01(document.getElementById("G4_critBase").value),

    totalSlots: Number(document.getElementById("C5_totalSlots").value),
    sharpCnt:   Number(document.getElementById("E5_sharpCnt").value),
    topN:       Number(document.getElementById("G5_topN").value),
    roundMode:  Number(document.getElementById("I5_roundMode").value),

    // スキル類（必要になったら calc() 側で使う）
    attackSkillLv: Number(document.getElementById("C8_attackSkillLv").value),
    elemAtkUpLv:   Number(document.getElementById("C12_elemAtkUpLv").value),
    senseiKououLv: Number(document.getElementById("G12_senseiKououLv").value),
    shinganLv:     Number(document.getElementById("G9_shinganLv").value),

    kokushokuIttaiOn:  isOnSelect("I9_kokushokuIttaiOn"),

    superCritLv: Number(document.getElementById("C15_superCritLv").value),

    // ここから下は、まだUI寄せの段階なので一旦持つだけでOK
    // （calc() で使わないなら無視される）
    kougekiLv: Number(document.getElementById("E8_kougekiLv").value),
    fullChargeLv: Number(document.getElementById("G8_fullChargeLv").value),
    semeNoShuseiLv: Number(document.getElementById("I8_semeNoShuseiLv").value),
    gyakushuLv: Number(document.getElementById("C9_gyakushuLv").value),
    nushiNoTamashiiOn: isOnSelect("E9_nushiNoTamashiiOn"),
    saikaLv: Number(document.getElementById("E12_saikaLv").value),
    critAttackElemLv: Number(document.getElementById("I12_critAttackElemLv").value),
    wexLv: Number(document.getElementById("E15_wexLv").value),
    konshinLv: Number(document.getElementById("G15_konshinLv").value),
    chikaraNoKaihouLv: Number(document.getElementById("I15_chikaraNoKaihouLv").value),
    kyouryuuKokufukuOn:isOnSelect("C16_kyouryuuKokufukuOn"),
    mugaLv: Number(document.getElementById("E16_mugaLv").value),
    challengerLv: Number(document.getElementById("C19_challengerLv").value),
    rengekiLv: Number(document.getElementById("E19_rengekiLv").value),
    rengekiBoostLv: Number(document.getElementById("G19_rengekiBoostLv").value),
  };
}


function render(rows){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";
  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.rank}</td>
      <td>${Number(r.dmg).toFixed(3)}</td>
      <td>${r.type ?? ""}</td>
      <td class="mono">${r.combo ?? ""}</td>
      <td>${Number(r.critFinal).toFixed(3)}</td>
      <td>${Number(r.elemUncapped).toFixed(2)}</td>
      <td>${Number(r.elemCapped).toFixed(2)}</td>
      <td>${Number(r.elemCap).toFixed(2)}</td>
      <td class="${r.isElemCapped?'ok':'muted'}">${r.isElemCapped?'YES':'NO'}</td>
    `;
    tbody.appendChild(tr);
  }
}

function setStatus(msg){ document.getElementById("status").textContent = msg; }

document.getElementById("btnCalc").addEventListener("click", () => {
  try{
    const input = getInput();
    const rows = calc(input);
    render(rows);

    document.getElementById("summary").textContent =
      `A=${input.A_base}, E=${input.E_base}, hzvRaw=${input.hzvRaw}, hzvElem=${input.hzvElem} / 結果=${rows.length}件`;

    setStatus("OK");
  }catch(e){
    console.error(e);
    setStatus("エラー: " + (e?.message ?? String(e)));
  }
});

document.getElementById("btnReset").addEventListener("click", () => {
  location.reload();
});

function toRate01(v){
  const x = Number(v);
  if(!Number.isFinite(x)) return NaN;
  if(x > 1) return x / 100;  // 45 -> 0.45
  return x;                  // 0.45 -> 0.45
}


// 公開時のみ広告枠を有効化（今は false）
if (IS_PUBLIC) {
  document.getElementById("ads-bottom").style.display = "block";
}
</script>
</body>
</html>
